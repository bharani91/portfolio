(function(a){function d(b){var c=a(b);while(c.length>0){var d=c.data("nested-fields.options");if(d)return d;c=c.parent()}return null}function e(a){a.add.bind("click.nested-fields",function(b){b.preventDefault(),h(null,a)})}function f(b,c){a(b.itemSelector,c).each(function(a,c){l(c,b)})}function g(b){var c=new RegExp(b.newItemIndex,"g"),d=(new Date).getTime(),e=b.itemTemplate.html();b.unescapeTemplate&&(e=o(e));var f=a(e.replace(c,d));return f.attr("data-new-record",!0),f.attr("data-record-id",d),l(f,b),f}function h(a,b){function d(){a&&a(c),i(b),b.container.append(c)}var c=g(b);return b.skipBefore?d():(b.beforeInsert(c,d),b.beforeInsert.length<=1&&d()),b.skipAfter||b.afterInsert(c),c}function i(a){n(a).remove()}function j(b,c){function d(){e.attr("data-new-record")?e.remove():(e.find("INPUT[name$='[_destroy]']").val("true"),e.hide()),k(c)}var e=a(b);return c.skipBefore?d():(c.beforeRemove(e,d),c.beforeRemove.length<=1&&d()),c.skipAfter||c.afterRemove(e),e}function k(a){if(m(a).length===0){var b=a.emptyTemplate.html();a.unescapeTemplate&&(b=o(b)),a.container.append(b)}}function l(b,c){var d=a(b).find(c.removeSelector),e=d.attr("data-confirm"),f=e?"confirm:complete":"click";d.bind(f+".nested-fields",function(a,d){a.preventDefault(),(d===undefined||d===!0)&&j(b,c)})}function m(a){return a.container.find(a.itemSelector+":visible")}function n(a){return a.container.find(a.emptySelector)}function o(a){var b=document.createElement("div");return b.innerHTML=a,b.childNodes.length===0?"":b.childNodes[0].nodeValue}function p(a){console&&console.log&&console.log(a)}var b={beforeInsert:function(a,b){b()},afterInsert:function(a){},beforeRemove:function(a,b){b()},afterRemove:function(a){},itemTemplateSelector:".item.template",emptyTemplateSelector:".empty.template",containerSelector:".items, .container",itemSelector:".item",emptySelector:".empty",addSelector:".add",removeSelector:".remove",newItemIndex:"new_nested_item",unescapeTemplate:!0},c={init:function(c){return this.each(function(){var d=a(this);if(d.data("nested-fields.options"))return p("Nested fields already defined for this element. If you want to redefine options, destroy it and init again."),d;c=a.extend({},b,c),c.itemTemplate=a(c.itemTemplateSelector,d),c.emptyTemplate=a(c.emptyTemplateSelector,d),c.container=a(c.containerSelector,d),c.add=a(c.addSelector,d),d.data("nested-fields.options",c),e(c),f(c,d)})},insert:function(b,c){return c=a.extend({},d(this),c),h(b,c)},remove:function(b,c){return c=a.extend({},d(this),c),j(b,c)},removeAll:function(b){b=a.extend({},d(this),b),a(c.items.apply(this)).each(function(a,d){c.remove(d,b)})},items:function(){return m(d(this))},destroy:function(){a(this).removeData("nested-fields.options"),a("*",this).unbind(".nested-fields")}};a.fn.nestedFields=function(b){if(c[b])return c[b].apply(this,Array.prototype.slice.call(arguments,1));if(typeof b=="object"||!b)return c.init.apply(this,arguments);a.error("Method "+b+" does not exist on jQuery.nestedFields")}})(jQuery)